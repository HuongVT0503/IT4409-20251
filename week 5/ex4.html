<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8">
    <title>Ex4</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
    <div class="wrap">
        <h1>Async Workflow Demo</h1>
        <p class="desc">
            Click "Get user", then "Get posts", then "Get post detail".
        </p>

        <div class="toolbar">
            <!--<button id="run" type="button">Run demo</button>-->
            <button id="getUser" type="button">Get user</button>
            <button id="getPosts" type="button">Get posts</button>
            <!--<button id="getPostDetail" type="button">Get post detail</button>-->
            <!--DONT NEED THIS BUTTON. THE USER CAN ONLY CALL GETPOSTDETTAIL AFTER SEEING THE POST LIST-->
            <button id="clear" type="button">Clear log</button>
        </div>

        <div class="cols">
            <div class="panel">
                <h2>User</h2>
                <div id="user"><em>No user yet.</em></div>
                <div class="panel">
                    <h2>Posts</h2>
                    <div id="posts">
                        <em id="none">No posts yet.</em>
                        <ul id="postlist"></ul>
                        <div id="postDetail"></div>

                    </div>

                </div>

                <div class="panel">
                    <h2>Log</h2>
                    <div id="log"></div> <!--log-->
                </div>
            </div>










            <script>
                function getUser() {
                    log("Bước 1. Gọi getUser()");
                    return new Promise((resolve) => {
                        setTimeout(() => {
                            const user = { id: 1, name: "Lam" };
                            log("User: " + user.name);
                            resolve(user);
                        }, 400);
                    });
                }

                function getPosts(userId) {
                    log("Bước 2. Gọi getPosts(" + userId + ")");
                    return new Promise((resolve) => {
                        setTimeout(() => {
                            const posts = [
                                { id: 101, title: "Post A" },
                                { id: 102, title: "Post B" },
                            ];
                            log("Posts: " + posts.map((p) => p.title).join(", "));
                            resolve(posts);
                        }, 400);
                    });
                }

                function getPostDetail(postId) {
                    log("Bước 3. Gọi getPostDetail(" + postId + ")");
                    return new Promise((resolve) => {
                        setTimeout(() => {
                            const detail = { id: postId, title: "Chi tiết bài viết " + postId };
                            log("Detail: " + detail.title);
                            resolve(detail);
                        }, 400);
                    });
                }

                ///

                let currentUser=null;
                let currentPosts=[];

                function log(msg) {     //add to the log
                    const logbox = document.getElementById("log");
                    const p = document.createElement("p");
                    const timestamp = new Date().toLocaleTimeString();
                    p.textContent = timestamp + ": " + msg;
                    logbox.prepend(p);  //add new log to the top
                }


                //MAKE THE TITLES/USER NAME/ POST ETC CLICKABLE
                function renderUser(user) {
                    const box = document.getElementById("user");
                    box.innerHTML =
                        `<button class="user-btn" data-user-id="${user.id}">
                        ${user.name} (id: ${user.id})
                    </button>`;
                }

                function renderPosts(posts) {
                    const postlist = document.getElementById("postlist");
                    postlist.innerHTML = "";

                    if (!posts || posts.length === 0) {
                        return;
                    }

                    for (const p of posts) {
                    const li = document.createElement("li");
                    li.innerHTML =
                        `<button class="post-btn" data-post-id="${p.id}">
                        ${p.title} (id: ${p.id})
                        </button>`;
                    postlist.appendChild(li);
                    }

                }

                function renderPostDetail(detail) {
                    const box = document.getElementById("postDetail");
                    const detailEl = document.createElement("p");
                    detailEl.textContent = ` ${detail.title}`;
                    box.appendChild(detailEl);
                }


                /////////

                //USE DELEGATION TO TIE

                //for user-btn
                //click user name->getPOsts()
                document.getElementById("user").addEventListener("click", (e) => {
                    const btn = e.target.closest(".user-btn");//e.target.closest()->nearest ancestor of an element (including the element itself) that matches a specified CSS selector
                    if (!btn) return;
                    const userId = Number(btn.dataset.userId);
                    log(`Gọi getPosts với userId=${userId}`);
                    handleGetPosts();
                });

                //for post-btn
                document.getElementById("posts").addEventListener("click", (e) => {
                    const btn = e.target.closest(".post-btn");
                    if (!btn) return;
                    const postId = Number(btn.dataset.postId);
                    log(`Gọi getPostDetail với postId=${postId}`);
                    handleGetPostDetail(postId);
                });


                /////




                ///HANDLERSFOR THE BUTTONS
                function handleGetUser() {
                    getUser().then((user) => {
                        currentUser = user;
                        renderUser(user);
                    });
                }

                function handleGetPosts() {
                    if (!currentUser) {
                        log("No user yet. Click 'Get user' first.");
                        return;
                    }
                    document.getElementById("none").innerHTML = "";
                    getPosts(currentUser.id).then((posts) => {
                        currentPosts = posts;
                        renderPosts(posts);
                    });
                }

                function handleGetPostDetail(postId) {
                    getPostDetail(postId).then((detail) => {
                        renderPostDetail(detail);
                    });
                }






                document.getElementById("getUser").addEventListener("click", handleGetUser);
                document.getElementById("getPosts").addEventListener("click", handleGetPosts);//!!!
                //document.getElementById("getPostDetail").addEventListener("click", handleGetPostDetail);
                
                document.getElementById("clear").addEventListener("click", () => {
                    document.getElementById("log").innerHTML = "";
                    document.getElementById("postlist").innerHTML = "";
                    document.getElementById("none").innerHTML = "No posts yet.";
                    document.getElementById("postDetail").innerHTML = "";
                    document.getElementById("user").innerHTML = `<em>No user yet.</em>`;

                    currentUser = null;
                    currentPosts = [];
                });




            </script>
</body>

</html>